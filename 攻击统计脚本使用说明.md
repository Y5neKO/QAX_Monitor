# 攻击统计脚本使用说明

## 功能概述

攻击统计脚本 (`attack_statistics.py`) 用于统计防火墙和探针目录下的攻击次数，生成标准化的统计报告。

## 主要功能

1. **多格式CSV支持** - 自动识别CSV分隔符（逗号、制表符、分号）
2. **智能IP提取** - 支持多种IP列名格式
3. **攻击次数统计** - 分别统计防火墙和探针的攻击次数
4. **独立IP统计** - 统计探针目录下的独立攻击IP数量
5. **高风险IP识别** - 识别超过50次攻击的IP地址
6. **自定义报告模板** - 支持用户自定义报告格式
7. **数字格式化** - 超过1万的数字自动转换为x.xxxxW格式
8. **文件输出** - 支持将报告保存到文件

## 安装要求

- Python 3.6+
- 无需额外依赖包（仅使用标准库）

## 使用方法

### 基本用法

```bash
python3 attack_statistics.py --firewall-dir <防火墙目录> --probe-dir <探针目录>
```

### 完整参数

```bash
python3 attack_statistics.py \
    --firewall-dir /path/to/firewall \
    --probe-dir /path/to/probe \
    --template report_template.txt \
    --output statistics_report.txt
```

### 参数说明

- `--firewall-dir`: 防火墙CSV文件目录路径（必需）
- `--probe-dir`: 探针CSV文件目录路径（必需）
- `--template`: 自定义报告模板文件路径（可选）
- `--output`: 输出报告文件路径（可选，默认输出到控制台）
- `--create-template`: 创建模板示例文件

### 创建模板示例

```bash
python3 attack_statistics.py --create-template
```

## 支持的CSV格式

### IP列名支持

脚本自动识别以下IP列名：
- `src_ip`, `source_ip`, `sip`, `源IP`, `攻击源IP`, `源地址`
- `dst_ip`, `dest_ip`, `dip`, `目标IP`, `目标地址`
- `ip`, `client_ip`, `server_ip`, `host_ip`, `攻击IP`

### CSV分隔符支持

- 逗号分隔 (`,`)
- 制表符分隔 (`\t`)
- 分号分隔 (`;`)

## 报告模板

### 默认模板（已优化简化占位符）

```
山南防火墙共监测到{防火墙攻击次数}次攻击，山南探针共监测{探针攻击ip数}个IP的{探针攻击次数}次攻击，分析了{探针攻击次数}条告警日志，分析后进行了{高风险ip数}次封堵，未发现攻击成功事件，并根据威胁情报封禁了0个IP。
```

### 占位符说明（新版本 - 简化名称）

- `{防火墙攻击次数}` - 防火墙总攻击次数（自动格式化：超过1万显示x.xxxxW）
- `{探针攻击次数}` - 探针总攻击次数（自动格式化：超过1万显示x.xxxxW）
- `{探针攻击ip数}` - 探针独立IP数量
- `{高风险ip数}` - 合并后超过50次攻击的IP数量

### 兼容性说明

脚本同时支持旧版本的占位符名称，确保向后兼容：
- `{防火墙攻击次数（超过1万就记成x.xxxxW）}` → `{防火墙攻击次数}`
- `{探针攻击次数（超过1万就记成x.xxxxW）}` → `{探针攻击次数}`
- `{和在一起，超过50次的ip数量}` → `{高风险ip数}`

### 自定义模板

可以创建任何格式的模板文件，只需要包含相应的占位符即可。

## 输出示例

### 控制台输出

```
============================================================
攻击统计工具
============================================================
正在读取防火墙目录: test_data/firewall
✓ 成功读取文件: high_attack_freq.csv (90 条记录)
✓ 成功读取文件: firewall_logs.csv (105 条记录)
✓ 成功读取文件: super_high_freq.csv (165 条记录)
正在读取探针目录: test_data/probe
✓ 成功读取文件: probe_logs.csv (19 条记录)
------------------------------------------------------------
正在统计数据...
防火墙攻击次数: 15165 (1.5165W)
探针攻击次数: 19 (19)
探针独立IP数: 11
超过50次攻击的IP数量: 4

超过50次攻击的IP列表:
  192.168.1.400: 5000 次
  192.168.1.401: 5000 次
  192.168.1.402: 5000 次
  192.168.1.300: 60 次
------------------------------------------------------------
统计报告:
山南防火墙共监测到1.5165W次攻击，山南探针共监测11个IP的19次攻击，分析了19条告警日志，分析后进行了4次封堵，未发现攻击成功事件，并根据威胁情报封禁了0个IP。

✓ 统计完成！
```

## 数字格式化

- 小于10000：显示原数字（如：`500`, `9999`）
- 大于等于10000：显示为x.xxxxW格式（如：`1.5165W`, `2.3000W`）

## 注意事项

1. **文件编码** - 脚本自动处理UTF-8编码，对无法解码的文件会忽略错误
2. **空文件处理** - 自动跳过空行和无效数据
3. **目录检查** - 脚本会检查目录是否存在，如果不存在会给出警告
4. **IP验证** - 使用正则表达式验证IP地址格式，确保提取的是有效IP
5. **大文件处理** - 脚本可以处理大型CSV文件，内存使用效率较高

## 错误处理

脚本包含完整的错误处理机制：
- 文件不存在时会给出明确提示
- CSV格式错误时会跳过问题文件继续处理
- 权限问题会给出相应的错误信息

## 性能特点

- **内存优化** - 逐行读取CSV文件，不会将整个文件加载到内存
- **快速处理** - 使用高效的字典和集合数据结构进行统计
- **并发安全** - 单线程处理，避免多线程同步问题

## 扩展性

脚本设计具有良好的扩展性：
- 可以轻松添加新的IP列名支持
- 可以扩展数字格式化规则
- 可以增加新的统计维度
- 可以支持更多的CSV格式

## 示例数据

项目包含完整的测试数据：
- `test_data/firewall/` - 防火墙测试数据
- `test_data/probe/` - 探针测试数据
- `report_template.txt` - 报告模板示例

可以直接使用测试数据验证脚本功能。