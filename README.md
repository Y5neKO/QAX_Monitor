# QAX安全设备日志监控脚本

这个Python脚本用于自动监控QAX安全设备的威胁日志，并定期导出和下载日志文件。

## 功能特性

- 自动监控QAX安全设备的威胁日志
- **多设备同时监控**: 支持同时监控多个设备，每个设备独立配置
- **设备特定间隔**: 每个设备可以单独设置监控间隔时间
- **自动配置加载**: 从configs目录自动读取所有设备配置文件
- **自定义文件名**: 支持通过命令行参数自定义导出文件名格式
- **灵活时间间隔**: 支持任意分钟数的监控间隔（不再限制10的倍数）
- 自动导出指定时间范围的日志
- 自动下载导出的日志文件并保存到本地
- 完整的错误处理和日志记录
- 支持长时间运行的后台监控
- **智能时间对齐**: 自动对齐到时间间隔的整数倍时间点
- **独立监控模式**: 不同间隔时间的设备独立监控，相同间隔的设备同步监控
- **自动重试机制**: 导出失败时自动重试3次
- **语音报警**: 失败时播放语音提醒（支持Windows/Linux）
- **调试模式**: 详细记录请求响应信息便于排错
- **独立目录**: 每个设备的日志文件保存在独立目录中
- **智能解析**: 自动从HTTP请求包中提取IP、Token、Cookie
- **防重复覆盖**: 自动避免文件名重复，添加数字后缀
- **彩色输出**: 支持彩色控制台输出，重点信息突出显示
- **时间段预览**: 在监控周期开始时显示导出的时间段
- **优雅退出**: 支持Ctrl+C安全停止所有监控线程

## 环境要求

- Python 3.6+
- 依赖包：requests

## 安装依赖

```bash
# 基本依赖
pip install -r requirements.txt

# Windows系统启用语音报警（可选）
pip install pywin32

# Linux系统启用语音报警（可选）
# Ubuntu/Debian: sudo apt-get install espeak
# CentOS/RHEL: sudo yum install espeak
```

## 使用方法

### 多设备监控（推荐）

#### 方式一：自动配置（推荐）

```bash
python qax_monitor.py --auto-config <配置目录> --interval <间隔分钟>
```

**配置目录结构**:
```
configs/
├── 主设备.txt          # 使用默认间隔时间
├── 备用设备-15.txt     # 间隔时间：15分钟
├── 测试设备-5.txt      # 间隔时间：5分钟
└── 监控设备-30.txt     # 间隔时间：30分钟
```

**设备特定间隔时间**:
- 文件名格式：`设备名-间隔时间.txt`
- 如果文件名包含数字后缀，会自动解析为间隔时间
- 例如：`设备A-10.txt` 表示设备A的监控间隔为10分钟
- 如果文件名没有数字后缀，则使用默认间隔时间

**自动配置示例**:
```bash
# 自动加载configs目录下的所有设备配置，使用默认间隔时间
python qax_monitor.py --auto-config configs --interval 15

# 设备文件中已指定间隔时间，--interval参数作为默认值
python qax_monitor.py --auto-config configs --log-name "某某项目-{日期}-{时间范围}"

# 使用自定义配置目录，启用调试模式
python qax_monitor.py --auto-config /path/to/configs --log-name "项目日志-{开始日期时间}-{结束日期时间}" --debug

# 自定义文件名格式
python qax_monitor.py --auto-config configs --interval 15 --log-name "某某项目-{日期}-{时间范围}"
```

#### 方式二：手动配置

```bash
python qax_monitor.py --devices <设备配置列表> --interval <间隔分钟>
```

**设备配置格式**:
```
设备名1:IP1:Token1:Cookie1,设备名2:IP2:Token2:Cookie2
```

**手动配置示例**:
```bash
# 同时监控两个设备，每15分钟一次
python qax_monitor.py --devices "设备A:30.128.74.13:token1:cookie1,设备B:30.128.74.14:token2:cookie2" --interval 15

# 自定义文件名格式
python qax_monitor.py --devices "设备A:30.128.74.13:token1:cookie1,设备B:30.128.74.14:token2:cookie2" --interval 15 --log-name "项目日志-{设备名}-{开始日期时间}-{结束日期时间}"

# 禁用彩色输出
python qax_monitor.py --devices "设备A:30.128.74.13:token1:cookie1,设备B:30.128.74.14:token2:cookie2" --interval 15 --no-color

# 启用调试模式查看详细信息
python qax_monitor.py --auto-config configs --debug
```

### 单设备监控（向后兼容）

```bash
python qax_monitor.py --ip <设备IP> --interval <间隔分钟> --token <认证令牌> --cookie <会话Cookie>
```

#### 单设备示例

```bash
# 每7分钟监控一次
python qax_monitor.py --ip 30.128.74.13 --interval 7 --token a2d6617e42197c7c503a4f4c3f0efb93 --cookie "__s_sessionid__=a8e1a1b79822b085e12a4d407e0ed0fe"

# 每12分钟监控一次，启用调试模式
python qax_monitor.py --ip 192.168.1.100 --interval 12 --token your_token_here --cookie your_cookie_here --debug

# 自定义文件名格式
python qax_monitor.py --ip 30.128.74.13 --interval 7 --token a2d6617e42197c7c503a4f4c3f0efb93 --cookie "__s_sessionid__=a8e1a1b79822b085e12a4d407e0ed0fe" --log-name "某某项目-{日期}-{时间范围}"
```

### 参数说明

#### 多设备模式
- `--auto-config`: 自动从指定目录加载所有设备配置（与--devices互斥）
- `--devices`: 手动指定设备配置列表（与--auto-config互斥）
- `--interval`: 默认监控间隔时间，单位分钟（可选，设备文件未指定时使用）
- `--log-name`: 自定义日志文件名格式（可选）
- `--debug`: 启用调试模式（可选）
- `--no-color`: 禁用彩色输出（可选）

#### 单设备模式
- `--ip`: QAX设备的IP地址（必需）
- `--interval`: 监控间隔时间，单位分钟（必需）
- `--token`: 认证令牌（必需）
- `--cookie`: 会话Cookie（必需）
- `--log-name`: 自定义日志文件名格式（可选）
- `--debug`: 启用调试模式（可选）
- `--no-color`: 禁用彩色输出（可选）

### 配置文件格式

当使用`--auto-config`时，需要在配置目录中放置请求包文件（.txt格式）。

**配置文件要求**:
- 文件名作为设备名称（不含.txt扩展名），支持间隔时间设置：`设备名-间隔时间.txt`
- 文件内容为完整的HTTP请求包
- 必须包含以下字段：
  - `Host:` 或 `:authority:` - 设备IP地址
  - `token:` - 认证令牌
  - `cookie:` - 会话Cookie

**配置文件示例** (`configs/示例设备-15.txt`):
```
POST /data.html HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate, br, zstd
Accept-Language: zh-CN,zh;q=0.9,zh-TW;q=0.8
Connection: keep-alive
Content-Length: 247
Content-Type: application/json; charset=UTF-8
Cookie: __s_sessionid__=a538b36ab3e36f61a1d557d287f35fb7
Host: 30.128.74.13
Origin: https://30.128.74.13
Referer: https://30.128.74.13/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36
X-Requested-With: XMLHttpRequest
token: 8f4c4db16b588daa4e219fcc00cb11c2

[{"head":{"function":"export_log_threat","module":"stored","page_index":1,"page_size":10000},"body":{"log_show":{"filter":"((threat_type eq '全部威胁类型'))","time_start":"2025-10-11 14:12:10","time_end":"2100-01-01 10:59:59","order":"descend","password":""}}}]
```

**支持格式**:
- ✅ **标准HTTP请求格式** (推荐): `Host: 30.128.74.13`
- ✅ **旧格式兼容**: `:authority:` 和值在下一行
- ✅ **设备特定间隔时间**: `设备名-15.txt` 表示15分钟间隔

### 获取Cookie和Token的方法

**方法一：从浏览器开发者工具获取**
1. 打开浏览器，访问QAX设备管理界面
2. 按F12打开开发者工具，切换到Network标签
3. 执行一次日志导出操作
4. 在Network中找到`/data.html`的POST请求
5. 右键点击请求 → Copy → Copy as cURL (bash)
6. 从cURL命令中提取所需的请求头信息
7. 保存为.txt文件并放入configs目录

**方法二：直接复制HTTP请求**
1. 在浏览器开发者工具中找到`/data.html`请求
2. 右键点击请求 → Copy → Copy request headers
3. 粘贴到文本文件中，确保包含Host、Cookie、token字段
4. 在文件末尾添加请求体JSON数据
5. 保存为.txt文件并放入configs目录

**配置文件命名规范**:
- `主设备.txt` - 使用默认间隔时间
- `备用设备-20.txt` - 间隔时间：20分钟
- `测试设备-5.txt` - 间隔时间：5分钟
- `监控设备-30.txt` - 间隔时间：30分钟

### 文件名格式说明

使用`--log-name`参数可以自定义导出文件的命名格式。支持以下占位符：

**基础时间占位符**:
- `{日期}` - 开始日期（格式：YYYYMMDD）
- `{时间}` - 结束时间（格式：HHMM）
- `{时间范围}` - 时间范围（格式：HHMM-HHMM）

**详细时间占位符**:
- `{开始日期}` - 开始日期（YYYYMMDD）
- `{结束日期}` - 结束日期（YYYYMMDD）
- `{开始时间}` - 开始时间（HHMM）
- `{结束时间}` - 结束时间（HHMM）
- `{开始日期时间}` - 开始日期时间（YYYYMMDD_HHMM）
- `{结束日期时间}` - 结束日期时间（YYYYMMDD_HHMM）
- `{完整时间范围}` - 完整时间范围（HHMMSS-HHMMSS）

**设备信息占位符**:
- `{设备名}` - 设备名称
- `{设备IP}` - 设备IP地址

**日期组件占位符**:
- `{年}` - 年份（YYYY）
- `{月}` - 月份（MM）
- `{日}` - 日期（DD）
- `{开始小时}` - 开始小时（HH）
- `{开始分钟}` - 开始分钟（MM）
- `{结束小时}` - 结束小时（HH）
- `{结束分钟}` - 结束分钟（MM）

**文件名示例**:
```bash
# 示例1：某某项目-{日期}-{时间范围}
# 生成文件名：某某项目-20251012-1430-1440.csv

# 示例2：{设备名}_ThreatLog_{开始日期时间}-{结束日期时间}
# 生成文件名：设备A_ThreatLog_20251012_1430-20251012_1440.csv

# 示例3：项目日志{年}{月}{日}_{开始小时}{开始分钟}-{结束小时}{结束分钟}
# 生成文件名：项目日志20251012_1430-1440.csv

# 示例4：Security-Log-{设备IP}-{完整时间范围}
# 生成文件名：Security-Log-30.128.74.13-143030-144000.csv
```

**注意事项**:
- 占位符必须用花括号`{}`包围
- 系统会自动清理文件名中的非法字符（如`<>"/\|?*`）
- 如果文件名重复，会自动添加数字后缀（如：`文件名_1.csv`）
- 不使用`--log-name`时，默认格式为：`{设备名}-{日期}-{时间}.csv`

## 工作流程

### 多设备监控流程

#### 相同间隔时间
1. **初始化连接**: 为每个设备建立独立的连接
2. **智能时间计算**: 自动计算下一个目标时间点（间隔时间的整数倍）
3. **等待目标时间**: 每10秒检查一次是否到达目标时间点
4. **并行监控**: 到达目标时间时，同时为所有设备启动监控线程
5. **并发执行**: 每个设备独立执行日志导出和下载任务
6. **自动重试**: 如果单个设备失败，自动重试3次
7. **语音报警**: 设备失败时播放语音提醒
8. **结果汇总**: 显示所有设备的监控结果统计
9. **循环监控**: 等待下一个目标时间点，重复上述流程

#### 不同间隔时间（独立监控模式）
1. **初始化连接**: 为每个设备建立独立的连接
2. **独立线程**: 为每个设备创建独立的监控线程
3. **设备特定时间计算**: 每个设备根据自己的间隔时间计算目标时间点
4. **独立监控**: 每个设备按照自己的时间节奏独立监控
5. **自动重试**: 如果设备失败，自动重试3次
6. **语音报警**: 设备失败时播放语音提醒
7. **独立记录**: 每个设备的监控结果独立记录

### 单设备监控流程

1. **初始化连接**: 使用提供的IP、token和cookie建立与设备的连接
2. **智能时间计算**: 自动选择最近的间隔时间整数倍作为开始时间
3. **等待目标时间**: 每10秒检查一次是否到达目标时间点
4. **日志导出**: 向设备发送导出请求，导出指定时间范围的威胁日志
5. **自动重试**: 如果导出失败，自动重试3次，每次间隔5秒
6. **语音报警**: 重试失败后播放语音提醒"发生报错，请人工排除"
7. **文件下载**: 从设备下载导出的CSV日志文件
8. **本地保存**: 将下载的文件保存到设备专用目录
9. **循环监控**: 等待下一个目标时间点，重复上述流程

## 输出文件

- **日志文件**: `qax_monitor.log` - 记录监控过程的详细信息
- **多设备目录结构**:
  ```
  downloaded_logs/
  ├── 设备A/
  │   ├── log_export_threat_xxx.csv
  │   └── ...
  ├── 设备B/
  │   ├── log_export_threat_yyy.csv
  │   └── ...
  └── ...
  ```
- **单设备目录**: `downloaded_logs/设备名/` - 存放该设备的所有日志文件
- **文件命名**: 保持设备导出的原始文件名格式（如：`log_export_threat_1760246465.csv`）

## 注意事项

1. **网络连接**: 确保能够访问所有QAX设备的IP地址
2. **Token有效性**: 确保提供的token有效且未过期
3. **时间间隔**: 支持任意分钟数的间隔（如：7、12、25分钟等）
4. **设备特定间隔**: 不同设备可以有不同的监控间隔时间
5. **文件命名**: 设备文件名格式为`设备名-间隔时间.txt`，间隔时间必须是数字
6. **配置文件格式**: 使用自动配置时，确保配置文件包含必需的字段（:authority:, token:, cookie:）
7. **文件编码**: 配置文件必须使用UTF-8编码保存
8. **多设备配置**: 确保每个设备的配置信息正确无误
9. **SSL证书**: 脚本会忽略SSL证书验证，适用于内网环境
10. **存储空间**: 长时间运行会占用一定的磁盘空间，请定期清理日志文件
11. **并发限制**: 多设备监控时会同时发起多个网络请求，确保网络带宽充足
12. **资源使用**: 不同间隔时间的设备会创建多个独立线程，注意系统资源使用

## 停止监控

按 `Ctrl+C` 可以安全停止监控脚本。

## 错误处理

脚本包含完整的错误处理机制：

- **自动重试**: 网络连接失败或API调用失败时自动重试3次
- **语音报警**: 重试失败后触发语音提醒"发生报错，请人工排除"
- **详细日志**: 记录详细的错误信息和响应内容
- **调试模式**: 使用`--debug`参数查看完整的请求响应过程
- **异常恢复**: 文件下载失败不会影响后续监控周期
- **优雅降级**: 语音库不可用时仍能正常运行

## 日志说明

脚本会输出两种日志：

1. **控制台输出**: 实时显示监控状态和结果
2. **文件日志**: 保存到`qax_monitor.log`，便于后续排查问题

## 安全提示

- 请妥善保管认证token，避免泄露
- 建议在受信任的网络环境中使用
- 定期检查和清理下载的日志文件